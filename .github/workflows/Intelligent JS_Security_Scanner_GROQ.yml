name: Intelligent JS Security Scanner

on:
  push:
    branches: [main, master]
    paths:
      - 'targets.txt'
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: write
  actions: read

jobs:
  intelligent-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Setup Directories
        run: |
          mkdir -p final_reports screenshots tmp
          echo "âœ… Directories created"

      - name: Cache Tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: |
            ~/go/bin
            ~/.local/bin
          key: ${{ runner.os }}-intelligent-tools-v3
          restore-keys: |
            ${{ runner.os }}-intelligent-tools-

      - name: Install Tools
        run: |
          set -e
          
          echo "ğŸ“¦ Installing Python packages..."
          pip install --break-system-packages groq aiohttp beautifulsoup4 || {
            echo "âš ï¸ Pip install failed, trying without cache"
            pip install --no-cache-dir --break-system-packages groq aiohttp beautifulsoup4
          }
          
          echo "ğŸ“¦ Installing Go tools..."
          if [[ ! -f ~/go/bin/katana ]]; then
            go install github.com/projectdiscovery/katana/cmd/katana@latest || {
              echo "âš ï¸ Katana install failed"
              exit 1
            }
          fi
          
          if [[ ! -f /usr/local/bin/gowitness ]]; then
            sudo curl -fsSL "https://github.com/sensepost/gowitness/releases/download/2.5.1/gowitness-2.5.1-linux-amd64" -o /usr/local/bin/gowitness || {
              echo "âš ï¸ Gowitness download failed"
              exit 1
            }
            sudo chmod +x /usr/local/bin/gowitness
          fi
          
          echo "âœ… All tools installed"

      - name: Add Tools to PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Create Intelligent JS Analyzer
        run: |
          cat > intelligent_js_scanner.py << 'PYTHON_SCRIPT'
          #!/usr/bin/env python3
          """
          Intelligent JS Scanner with Groq Brain
          Analyzes JavaScript for security issues using LLM reasoning
          """
          
          import os
          import sys
          import json
          import asyncio
          import re
          from typing import List, Dict, Optional
          
          try:
              from groq import Groq
              GROQ_AVAILABLE = True
          except ImportError:
              GROQ_AVAILABLE = False
              print("âš ï¸ Groq not installed - using pattern-only mode", file=sys.stderr)
          
          # Initialize Groq
          GROQ_API_KEY = os.getenv("GROQ_API_KEY")
          if not GROQ_API_KEY or not GROQ_AVAILABLE:
              print("âš ï¸ GROQ_API_KEY not set or groq not installed - using basic patterns only", file=sys.stderr)
              client = None
          else:
              try:
                  client = Groq(api_key=GROQ_API_KEY)
                  print("âœ… Groq client initialized", file=sys.stderr)
              except Exception as e:
                  print(f"âš ï¸ Groq init failed: {e}", file=sys.stderr)
                  client = None
          
          # High-confidence patterns
          CRITICAL_PATTERNS = {
              "api_key": r'(?i)(api[_-]?key|apikey)\s*[:=]\s*["\']([a-zA-Z0-9_\-]{20,})["\']',
              "secret": r'(?i)(secret|password|passwd)\s*[:=]\s*["\']([^"\']{8,})["\']',
              "aws_key": r'(?i)(aws_access_key_id|aws_secret_access_key)\s*[:=]\s*["\']([A-Z0-9]{20,})["\']',
              "private_key": r'-----BEGIN (RSA |EC |DSA )?PRIVATE KEY-----',
              "jwt": r'eyJ[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}',
              "bearer_token": r'(?i)bearer\s+[a-zA-Z0-9_\-\.]{20,}',
              "slack_token": r'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24,}',
              "github_token": r'gh[pousr]_[A-Za-z0-9_]{36,}',
          }
          
          # Exclude false positives
          BOILERPLATE = [
              "example", "demo", "test", "placeholder", "sample",
              "username", "password", "config", "type", "scheme",
              "datetime-local", "next/image", "react", "angular", "vue",
              "your_api_key", "your_secret", "insert_", "replace_"
          ]
          
          
          def is_boilerplate(text: str) -> bool:
              """Check if text contains boilerplate"""
              text_lower = text.lower()
              return any(bp in text_lower for bp in BOILERPLATE)
          
          
          def extract_context(js_content: str, match_pos: int, context_size: int = 100) -> str:
              """Extract surrounding context"""
              start = max(0, match_pos - context_size)
              end = min(len(js_content), match_pos + context_size)
              return js_content[start:end]
          
          
          def basic_pattern_scan(js_content: str, js_url: str) -> List[Dict]:
              """Scan using regex patterns"""
              findings = []
              
              for pattern_name, pattern in CRITICAL_PATTERNS.items():
                  try:
                      matches = re.finditer(pattern, js_content)
                      for match in matches:
                          context = extract_context(js_content, match.start())
                          
                          if is_boilerplate(context):
                              continue
                          
                          findings.append({
                              "type": pattern_name,
                              "severity": "HIGH",
                              "url": js_url,
                              "context": context.strip()[:200],
                              "match": match.group(0)[:100],
                              "confidence": "high_pattern"
                          })
                  except Exception as e:
                      print(f"Pattern error ({pattern_name}): {e}", file=sys.stderr)
                      continue
              
              return findings
          
          
          async def llm_analyze_js(js_content: str, js_url: str) -> Optional[Dict]:
              """Use Groq to analyze JS"""
              if not client:
                  return None
              
              suspicious_keywords = ["key", "secret", "token", "password", "api", "auth", "credential"]
              chunks = []
              
              for line in js_content.split('\n'):
                  if any(kw in line.lower() for kw in suspicious_keywords):
                      chunks.append(line)
              
              if not chunks:
                  return None
              
              sample = '\n'.join(chunks[:20])
              
              prompt = f"""Analyze this JavaScript for REAL security vulnerabilities.

          From: {os.path.basename(js_url)}

          Code:
          ```javascript
          {sample[:1500]}
          ```

          ONLY flag REAL issues with actual values:
          - Hardcoded API keys (not placeholders)
          - Real authentication tokens
          - Database credentials with values
          - Private keys

          IGNORE:
          - Variable names without values
          - Placeholders like "YOUR_API_KEY"
          - Comments
          - Configuration templates

          Return JSON (no markdown):
          {{
            "has_vulnerability": true/false,
            "type": "api_key|secret|token|private_key|none",
            "severity": "CRITICAL|HIGH|MEDIUM",
            "description": "What was found",
            "evidence": "Specific line",
            "false_positive_risk": "low|medium|high"
          }}"""
              
              try:
                  response = client.chat.completions.create(
                      model="llama-3.3-70b-versatile",
                      messages=[{"role": "user", "content": prompt}],
                      max_tokens=500,
                      temperature=0.3
                  )
                  
                  content = response.choices[0].message.content.strip()
                  
                  if "```" in content:
                      for part in content.split("```"):
                          if "{" in part:
                              content = part.strip()
                              break
                  
                  result = json.loads(content)
                  
                  if result.get("has_vulnerability") and result.get("false_positive_risk") != "high":
                      return {
                          "type": result.get("type", "unknown"),
                          "severity": result.get("severity", "MEDIUM"),
                          "url": js_url,
                          "description": result.get("description", "")[:200],
                          "evidence": result.get("evidence", "")[:200],
                          "confidence": "llm_verified"
                      }
              
              except Exception as e:
                  print(f"LLM error: {e}", file=sys.stderr)
              
              return None
          
          
          async def analyze_js_file(js_url: str, js_content: str) -> List[Dict]:
              """Analyze single JS file"""
              findings = []
              
              # Pattern matching
              pattern_findings = basic_pattern_scan(js_content, js_url)
              findings.extend(pattern_findings)
              
              # LLM analysis
              if client:
                  llm_finding = await llm_analyze_js(js_content, js_url)
                  if llm_finding:
                      findings.append(llm_finding)
              
              return findings
          
          
          async def main():
              if len(sys.argv) < 2:
                  print("Usage: python intelligent_js_scanner.py <js_files.txt>", file=sys.stderr)
                  sys.exit(1)
              
              js_files_list = sys.argv[1]
              
              if not os.path.exists(js_files_list):
                  print(f"âŒ File not found: {js_files_list}", file=sys.stderr)
                  sys.exit(1)
              
              with open(js_files_list, 'r') as f:
                  js_urls = [line.strip() for line in f if line.strip()]
              
              if not js_urls:
                  print("No JS files to analyze", file=sys.stderr)
                  print(json.dumps([]))
                  return
              
              print(f"ğŸ§  Intelligent JS Scanner", file=sys.stderr)
              print(f"   Files: {len(js_urls)}", file=sys.stderr)
              print(f"   LLM: {'âœ… Groq' if client else 'âŒ Pattern-only'}", file=sys.stderr)
              
              all_findings = []
              
              for i, js_url in enumerate(js_urls, 1):
                  print(f"[{i}/{len(js_urls)}] {os.path.basename(js_url)}", file=sys.stderr)
                  
                  js_file = f"tmp/js_{i}.js"
                  try:
                      import subprocess
                      result = subprocess.run(
                          ["curl", "-sL", "--max-time", "10", js_url, "-o", js_file],
                          capture_output=True,
                          timeout=12
                      )
                      
                      if result.returncode != 0:
                          print(f"  âš ï¸ Download failed", file=sys.stderr)
                          continue
                      
                      with open(js_file, 'r', errors='ignore') as f:
                          js_content = f.read()
                      
                      if len(js_content) < 100:
                          print(f"  âš ï¸ File too small", file=sys.stderr)
                          continue
                      
                      findings = await analyze_js_file(js_url, js_content)
                      
                      if findings:
                          print(f"  ğŸ”¥ {len(findings)} finding(s)", file=sys.stderr)
                          all_findings.extend(findings)
                      else:
                          print(f"  âœ“ Clean", file=sys.stderr)
                  
                  except Exception as e:
                      print(f"  âš ï¸ Error: {e}", file=sys.stderr)
              
              # Output JSON to stdout
              print(json.dumps(all_findings, indent=2))
              
              # Save to file
              with open("js_findings.json", "w") as f:
                  json.dump(all_findings, f, indent=2)
              
              print(f"\nğŸ“Š Total: {len(all_findings)}", file=sys.stderr)
              print(f"   Pattern: {sum(1 for f in all_findings if f.get('confidence') == 'high_pattern')}", file=sys.stderr)
              if client:
                  print(f"   LLM: {sum(1 for f in all_findings if f.get('confidence') == 'llm_verified')}", file=sys.stderr)
          
          
          if __name__ == "__main__":
              asyncio.run(main())
          PYTHON_SCRIPT
          
          chmod +x intelligent_js_scanner.py
          echo "âœ… Scanner created"

      - name: Run Intelligent Reconnaissance
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          set -euo pipefail
          
          # Ensure directories exist
          mkdir -p final_reports screenshots tmp
          
          # Initialize stats
          domains_scanned=0
          screenshots_taken=0
          js_files_analyzed=0
          findings_found=0
          
          # Validate targets
          if [[ ! -f targets.txt ]]; then
            echo "âŒ targets.txt not found"
            echo "Creating default targets.txt"
            echo "example.com" > targets.txt
          fi
          
          if [[ ! -s targets.txt ]]; then
            echo "âŒ targets.txt is empty"
            echo "example.com" > targets.txt
          fi
          
          # Select targets
          grep -v '^#' targets.txt | grep -v '^$' | shuf -n 4 > tmp/selected.txt || {
            echo "âš ï¸ No valid targets, using defaults"
            echo "example.com" > tmp/selected.txt
          }
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§  INTELLIGENT JS SECURITY SCANNER"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cat tmp/selected.txt | nl || echo "No targets"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Check Groq
          if [[ -n "${GROQ_API_KEY:-}" ]]; then
            echo "âœ… Groq LLM enabled"
          else
            echo "âš ï¸ Groq not configured (pattern-only mode)"
          fi
          echo ""
          
          # Process domains
          while read -r domain; do
            [[ -z "$domain" ]] && continue
            
            domain=$(echo "$domain" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')
            [[ -z "$domain" ]] && continue
            
            domains_scanned=$((domains_scanned + 1))
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ” DOMAIN $domains_scanned/4: $domain"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            report="final_reports/REPORT_${domain}.md"
            
            # Create report
            {
              echo "# ğŸ§  Intelligent JS Security Scan: $domain"
              echo "**Scan Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')"
              echo "**Domain:** $domains_scanned of 4"
              echo "**Run:** #${{ github.run_number }}"
              echo "**Intelligence:** ${GROQ_API_KEY:+Groq LLM}${GROQ_API_KEY:-Pattern-only}"
              echo ""
              echo "---"
              echo ""
            } > "$report" || {
              echo "âš ï¸ Failed to create report"
              continue
            }
            
            # Screenshot
            echo "ğŸ“¸ Screenshot..."
            if timeout 25s /usr/local/bin/gowitness single "https://$domain" -P screenshots/ --disable-db 2>/dev/null; then
              sleep 2
              latest=$(find screenshots/ -type f -name "*.png" -newer "$report" 2>/dev/null | head -1)
              if [[ -n "$latest" ]]; then
                mv "$latest" "screenshots/${domain}.png" 2>/dev/null && \
                  screenshots_taken=$((screenshots_taken + 1)) && \
                  echo "âœ“ Captured" || echo "âš ï¸ Move failed"
              fi
            else
              echo "âš ï¸ Timeout or failed"
            fi
            
            if [[ -f "screenshots/${domain}.png" ]]; then
              echo "## ğŸ“¸ Visual" >> "$report"
              echo "Screenshot: \`${domain}.png\`" >> "$report"
              echo "" >> "$report"
            fi
            
            # JS Analysis
            echo "ğŸ§  JS Analysis..."
            echo "## ğŸ§  JavaScript Security Analysis" >> "$report"
            
            if timeout 70s katana -u "https://$domain" -jc -d 2 -silent > tmp/urls_raw_${domain}.txt 2>/dev/null; then
              echo "âœ“ Crawl complete"
            else
              echo "âš ï¸ Crawl timeout"
              touch tmp/urls_raw_${domain}.txt
            fi
            
            if [[ -s tmp/urls_raw_${domain}.txt ]]; then
              # Filter JS
              grep -iE '\.js(\?|$)' tmp/urls_raw_${domain}.txt | \
                grep -iv '\.json' | \
                grep -vEi '(webpack|jquery|bootstrap|react|angular|vue|framework|polyfill|chunk|bundle|vendor|node_modules)' | \
                sort -u | head -n 10 > tmp/js_filtered_${domain}.txt || true
              
              js_count=$(wc -l < tmp/js_filtered_${domain}.txt 2>/dev/null || echo "0")
              
              if [[ $js_count -gt 0 ]]; then
                echo "**Analyzing $js_count files...**" >> "$report"
                echo "" >> "$report"
                
                # Run scanner
                if python3 intelligent_js_scanner.py tmp/js_filtered_${domain}.txt > tmp/scanner_output_${domain}.json 2> tmp/scanner_log_${domain}.txt; then
                  
                  if [[ -f tmp/scanner_output_${domain}.json ]] && [[ -s tmp/scanner_output_${domain}.json ]]; then
                    finding_count=$(jq '. | length' tmp/scanner_output_${domain}.json 2>/dev/null || echo "0")
                    
                    if [[ $finding_count -gt 0 ]]; then
                      findings_found=$((findings_found + finding_count))
                      
                      echo "### ğŸš¨ Security Findings ($finding_count)" >> "$report"
                      echo "" >> "$report"
                      
                      # Format findings
                      jq -r '.[] | "#### \(.severity): \(.type)\n**URL:** `\(.url)`\n**Confidence:** \(.confidence)\n\n```javascript\n\(if .evidence then .evidence else .context end)\n```\n"' tmp/scanner_output_${domain}.json >> "$report" 2>/dev/null || {
                        echo "**Raw findings:**" >> "$report"
                        cat tmp/scanner_output_${domain}.json >> "$report"
                      }
                      
                      echo "" >> "$report"
                      cp tmp/scanner_output_${domain}.json "tmp/findings_${domain}.json"
                    else
                      echo "*âœ… No security issues detected*" >> "$report"
                      echo "" >> "$report"
                    fi
                    
                    js_files_analyzed=$((js_files_analyzed + js_count))
                  else
                    echo "*No findings output*" >> "$report"
                    echo "" >> "$report"
                  fi
                else
                  echo "*Analysis error (see logs)*" >> "$report"
                  echo "" >> "$report"
                  cat tmp/scanner_log_${domain}.txt 2>/dev/null || true
                fi
              else
                echo "*No relevant JavaScript found*" >> "$report"
                echo "" >> "$report"
              fi
            else
              echo "*No JavaScript discovered*" >> "$report"
              echo "" >> "$report"
            fi
            
            echo "âœ… Complete: $domain"
            [[ $domains_scanned -lt 4 ]] && sleep 2
            
          done < tmp/selected.txt
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š SCAN COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Domains: $domains_scanned"
          echo "Screenshots: $screenshots_taken"
          echo "JS Files: $js_files_analyzed"
          echo "Findings: $findings_found"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Export to env
          echo "DOMAINS_SCANNED=$domains_scanned" >> $GITHUB_ENV
          echo "SCREENSHOTS_TAKEN=$screenshots_taken" >> $GITHUB_ENV
          echo "JS_FILES_ANALYZED=$js_files_analyzed" >> $GITHUB_ENV
          echo "FINDINGS_FOUND=$findings_found" >> $GITHUB_ENV
          
          if [[ $findings_found -gt 0 ]]; then
            echo "HAS_FINDINGS=true" >> $GITHUB_ENV
          else
            echo "HAS_FINDINGS=false" >> $GITHUB_ENV
          fi

      - name: Generate Summary
        if: always()
        run: |
          # Ensure directory exists
          mkdir -p final_reports
          
          # Create summary
          cat > final_reports/SUMMARY.md << SUMMARY_EOF
          # ğŸ§  Intelligent JS Security Scanner - Summary
          
          **Scan Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          **Run:** #${{ github.run_number }}
          **Intelligence:** ${GROQ_API_KEY:+âœ… Groq LLM}${GROQ_API_KEY:-âš ï¸ Pattern-only}
          
          ---
          
          ## ğŸ“Š Statistics
          
          | Metric | Count |
          |--------|------:|
          | Domains Scanned | ${DOMAINS_SCANNED:-0} |
          | Screenshots | ${SCREENSHOTS_TAKEN:-0} |
          | JS Files Analyzed | ${JS_FILES_ANALYZED:-0} |
          | **Security Findings** | **${FINDINGS_FOUND:-0}** |
          
          ## ğŸ¯ Targets
          
          $(cat tmp/selected.txt 2>/dev/null | nl -w2 -s'. ' || echo "None")
          
          ## ğŸ” Results
          
          $(if [[ "${FINDINGS_FOUND:-0}" -gt 0 ]]; then
            echo "ğŸš¨ **${FINDINGS_FOUND} security issue(s) detected**"
          else
            echo "âœ… **No security issues detected**"
          fi)
          
          ## ğŸ“ Reports
          
          $(ls final_reports/REPORT_*.md 2>/dev/null | sed 's/final_reports\//- /' || echo "- None")
          
          ---
          
          **Repo:** ${{ github.repository }}
          **Commit:** ${GITHUB_SHA:0:7}
          SUMMARY_EOF
          
          echo "âœ… Summary created"

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: intelligent-scan-${{ github.run_number }}
          path: |
            final_reports/
            screenshots/
            tmp/*.json
          retention-days: 14
          compression-level: 9

      - name: Commit History
        if: always() && env.DOMAINS_SCANNED != '0'
        continue-on-error: true
        run: |
          if [[ ! -d final_reports ]] || [[ -z "$(ls -A final_reports 2>/dev/null)" ]]; then
            echo "No results to commit"
            exit 0
          fi
          
          git config --global user.name "JS Scanner Bot"
          git config --global user.email "scanner@users.noreply.github.com"
          
          mkdir -p history && cd history
          git init
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          
          if git fetch origin js-scan-history 2>/dev/null; then
            git checkout js-scan-history
          else
            git checkout -b js-scan-history
          fi
          
          TIMESTAMP=$(date +%Y-%m-%d_%H%M)
          mkdir -p "scans/$TIMESTAMP"
          
          cp ../final_reports/*.md "scans/$TIMESTAMP/" 2>/dev/null || true
          [[ "${FINDINGS_FOUND:-0}" -gt 0 ]] && cp ../screenshots/*.png "scans/$TIMESTAMP/" 2>/dev/null || true
          [[ -f ../tmp/findings_*.json ]] && cp ../tmp/findings_*.json "scans/$TIMESTAMP/" 2>/dev/null || true
          
          git add scans/
          if ! git diff --staged --quiet; then
            git commit -m "Scan: $TIMESTAMP" \
              -m "Domains: ${DOMAINS_SCANNED:-0} | Findings: ${FINDINGS_FOUND:-0}"
            git push origin js-scan-history || echo "âš ï¸ Push failed"
          fi

      - name: Email Report
        if: always() && env.DOMAINS_SCANNED != '0'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "${{ env.HAS_FINDINGS == 'true' && 'ğŸš¨' || 'âœ…' }} JS Scan $(date +%Y-%m-%d) | ${{ env.FINDINGS_FOUND }} Finding(s)"
          to: ${{ secrets.EMAIL_USERNAME }}
          from: JS Security <js-scanner@security.local>
          body: |
            ğŸ§  INTELLIGENT JAVASCRIPT SECURITY SCAN
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ğŸ“… $(date '+%Y-%m-%d %H:%M UTC')
            ğŸ”„ Run #${{ github.run_number }}
            
            ğŸ“Š RESULTS
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ Domains:      ${{ env.DOMAINS_SCANNED }}
            â€¢ JS Files:     ${{ env.JS_FILES_ANALYZED }}
            â€¢ Screenshots:  ${{ env.SCREENSHOTS_TAKEN }}
            â€¢ ğŸ”¥ FINDINGS:  ${{ env.FINDINGS_FOUND }}
            
            ${{ env.HAS_FINDINGS == 'true' && 'ğŸš¨ SECURITY ISSUES FOUND' || 'âœ… NO ISSUES' }}
            
            ğŸ“ Full results: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          attachments: final_reports/*
          priority: ${{ env.HAS_FINDINGS == 'true' && 'high' || 'normal' }}

      - name: Critical Alert
        if: always() && env.HAS_FINDINGS == 'true' && env.FINDINGS_FOUND != '0'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸš¨ CRITICAL: ${{ env.FINDINGS_FOUND }} JS Security Issue(s)"
          to: ${{ secrets.EMAIL_USERNAME }}
          from: Critical Alert <critical@security.local>
          body: |
            âš ï¸âš ï¸âš ï¸  SECURITY ALERT  âš ï¸âš ï¸âš ï¸
            
            ${{ env.FINDINGS_FOUND }} SECURITY ISSUE(S) IN JAVASCRIPT
            
            Potential exposed credentials detected.
            Immediate review required.
            
            ğŸ“ Reports attached
            ğŸ”— ${{ github.repository }}/actions/runs/${{ github.run_id }}
          attachments: final_reports/REPORT_*.md
          priority: high

      - name: Cleanup
        if: always()
        run: |
          rm -rf tmp/*.js history/ 2>/dev/null || true
          echo "âœ… Cleanup done"
