- name: Run Recon and Analyze
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Detect files
          FILES=$(git diff --name-only HEAD^ HEAD | grep -E '\.js$|subdomains\.txt' || true)
          
          if [ -z "$FILES" ]; then
            echo "No files found to analyze."
            exit 0
          fi

          # 2. Analyze and force a consistent naming convention
          for file in $FILES; do
            filename=$(basename "$file")
            echo "Analyzing $filename..."
            # Using --yolo and ensuring we save to a clear .md file
            gemini --yolo -p "@$file Perform a security analysis." > "ANALYSIS_${filename}.md"
          done

          # 3. DEBUG: List files to see if they exist before the next step
          ls -lh ANALYSIS_*.md

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          # Change this to catch the specific prefix we just set
          path: ANALYSIS_*.md
          # If no files are found, make the action FAIL so you know immediately
          if-no-files-found: error
