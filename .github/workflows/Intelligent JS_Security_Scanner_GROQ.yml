name: Intelligent JS Security Scanner

on:
  push:
    branches: [main, master]
    paths:
      - 'targets.txt'
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: write
  actions: read

jobs:
  intelligent-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # Remove cache - causes error if no requirements.txt

      - name: Setup Directories
        run: |
          mkdir -p final_reports screenshots tmp
          echo "‚úÖ Directories created"

      - name: Cache Tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: |
            ~/go/bin
            ~/.local/bin
          key: ${{ runner.os }}-intelligent-tools-v4
          restore-keys: |
            ${{ runner.os }}-intelligent-tools-

      - name: Install Python Dependencies
        run: |
          echo "üì¶ Installing Python packages..."
          pip install --no-cache-dir groq aiohttp beautifulsoup4 || {
            echo "Retrying with --break-system-packages..."
            pip install --break-system-packages groq aiohttp beautifulsoup4
          }
          echo "‚úÖ Python packages installed"

      - name: Install Go Tools
        run: |
          set -e
          
          echo "üì¶ Installing Go tools..."
          
          # Add Go to PATH
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          
          # Install katana
          if [[ ! -f ~/go/bin/katana ]]; then
            echo "Installing katana..."
            go install github.com/projectdiscovery/katana/cmd/katana@latest || {
              echo "‚ùå Katana install failed"
              exit 1
            }
          else
            echo "‚úÖ Katana cached"
          fi
          
          # Install gowitness
          if [[ ! -f /usr/local/bin/gowitness ]]; then
            echo "Installing gowitness..."
            sudo curl -fsSL "https://github.com/sensepost/gowitness/releases/download/2.5.1/gowitness-2.5.1-linux-amd64" -o /usr/local/bin/gowitness || {
              echo "‚ùå Gowitness download failed"
              exit 1
            }
            sudo chmod +x /usr/local/bin/gowitness
          else
            echo "‚úÖ Gowitness cached"
          fi
          
          echo "‚úÖ All tools ready"

      - name: Verify Tools
        run: |
          echo "üîç Verifying tools..."
          which python3 && python3 --version
          which pip && pip --version
          which katana && katana -version || echo "‚ö†Ô∏è Katana not found"
          which gowitness && gowitness version || echo "‚ö†Ô∏è Gowitness not found"
          python3 -c "import groq; print('‚úÖ Groq OK')" || echo "‚ö†Ô∏è Groq not available"

      - name: Create Intelligent JS Analyzer
        run: |
          cat > intelligent_js_scanner.py << 'PYTHON_SCRIPT'
          #!/usr/bin/env python3
          """
          Intelligent JS Scanner with Groq Brain
          Analyzes JavaScript for security issues using LLM reasoning
          """
          
          import os
          import sys
          import json
          import asyncio
          import re
          from typing import List, Dict, Optional
          
          try:
              from groq import Groq
              GROQ_AVAILABLE = True
          except ImportError:
              GROQ_AVAILABLE = False
              print("‚ö†Ô∏è Groq not installed", file=sys.stderr)
          
          # Initialize Groq
          GROQ_API_KEY = os.getenv("GROQ_API_KEY")
          if not GROQ_API_KEY or not GROQ_AVAILABLE:
              print("‚ö†Ô∏è GROQ_API_KEY not set - pattern-only mode", file=sys.stderr)
              client = None
          else:
              try:
                  client = Groq(api_key=GROQ_API_KEY)
                  print("‚úÖ Groq initialized", file=sys.stderr)
              except Exception as e:
                  print(f"‚ö†Ô∏è Groq init failed: {e}", file=sys.stderr)
                  client = None
          
          # Patterns
          CRITICAL_PATTERNS = {
              "api_key": r'(?i)(api[_-]?key|apikey)\s*[:=]\s*["\']([a-zA-Z0-9_\-]{20,})["\']',
              "secret": r'(?i)(secret|password|passwd)\s*[:=]\s*["\']([^"\']{8,})["\']',
              "aws_key": r'(?i)(aws_access_key_id|aws_secret_access_key)\s*[:=]\s*["\']([A-Z0-9]{20,})["\']',
              "private_key": r'-----BEGIN (RSA |EC |DSA )?PRIVATE KEY-----',
              "jwt": r'eyJ[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}',
              "bearer_token": r'(?i)bearer\s+[a-zA-Z0-9_\-\.]{20,}',
              "slack_token": r'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24,}',
              "github_token": r'gh[pousr]_[A-Za-z0-9_]{36,}',
          }
          
          BOILERPLATE = [
              "example", "demo", "test", "placeholder", "sample",
              "username", "password", "config", "type", "scheme",
              "datetime-local", "next/image", "react", "angular", "vue",
              "your_api_key", "your_secret", "insert_", "replace_"
          ]
          
          
          def is_boilerplate(text: str) -> bool:
              text_lower = text.lower()
              return any(bp in text_lower for bp in BOILERPLATE)
          
          
          def extract_context(js_content: str, match_pos: int, context_size: int = 100) -> str:
              start = max(0, match_pos - context_size)
              end = min(len(js_content), match_pos + context_size)
              return js_content[start:end]
          
          
          def basic_pattern_scan(js_content: str, js_url: str) -> List[Dict]:
              findings = []
              
              for pattern_name, pattern in CRITICAL_PATTERNS.items():
                  try:
                      matches = re.finditer(pattern, js_content)
                      for match in matches:
                          context = extract_context(js_content, match.start())
                          
                          if is_boilerplate(context):
                              continue
                          
                          findings.append({
                              "type": pattern_name,
                              "severity": "HIGH",
                              "url": js_url,
                              "context": context.strip()[:200],
                              "match": match.group(0)[:100],
                              "confidence": "high_pattern"
                          })
                  except Exception as e:
                      continue
              
              return findings
          
          
          async def llm_analyze_js(js_content: str, js_url: str) -> Optional[Dict]:
              if not client:
                  return None
              
              suspicious_keywords = ["key", "secret", "token", "password", "api", "auth", "credential"]
              chunks = [line for line in js_content.split('\n') if any(kw in line.lower() for kw in suspicious_keywords)]
              
              if not chunks:
                  return None
              
              sample = '\n'.join(chunks[:20])
              
              prompt = f"""Analyze for REAL security issues (not placeholders).

          File: {os.path.basename(js_url)}

          Code:
          ```
          {sample[:1500]}
          ```

          Flag ONLY if real credentials with actual values.
          IGNORE placeholders like "YOUR_API_KEY".

          JSON (no markdown):
          {{
            "has_vulnerability": true/false,
            "type": "api_key|secret|token|none",
            "severity": "CRITICAL|HIGH",
            "description": "what found",
            "evidence": "specific line",
            "false_positive_risk": "low|high"
          }}"""
              
              try:
                  response = client.chat.completions.create(
                      model="llama-3.3-70b-versatile",
                      messages=[{"role": "user", "content": prompt}],
                      max_tokens=500,
                      temperature=0.3
                  )
                  
                  content = response.choices[0].message.content.strip()
                  if "```" in content:
                      content = [p for p in content.split("```") if "{" in p][0].strip()
                  
                  result = json.loads(content)
                  
                  if result.get("has_vulnerability") and result.get("false_positive_risk") != "high":
                      return {
                          "type": result.get("type", "unknown"),
                          "severity": result.get("severity", "HIGH"),
                          "url": js_url,
                          "description": result.get("description", "")[:200],
                          "evidence": result.get("evidence", "")[:200],
                          "confidence": "llm_verified"
                      }
              
              except Exception as e:
                  print(f"LLM error: {e}", file=sys.stderr)
              
              return None
          
          
          async def analyze_js_file(js_url: str, js_content: str) -> List[Dict]:
              findings = basic_pattern_scan(js_content, js_url)
              
              if client:
                  llm_finding = await llm_analyze_js(js_content, js_url)
                  if llm_finding:
                      findings.append(llm_finding)
              
              return findings
          
          
          async def main():
              if len(sys.argv) < 2:
                  print("Usage: python intelligent_js_scanner.py <js_files.txt>", file=sys.stderr)
                  sys.exit(1)
              
              js_files_list = sys.argv[1]
              
              if not os.path.exists(js_files_list):
                  print(f"‚ùå Not found: {js_files_list}", file=sys.stderr)
                  sys.exit(1)
              
              with open(js_files_list, 'r') as f:
                  js_urls = [line.strip() for line in f if line.strip()]
              
              if not js_urls:
                  print("[]")
                  return
              
              print(f"üß† Scanner: {len(js_urls)} files", file=sys.stderr)
              print(f"   LLM: {'‚úÖ' if client else '‚ùå'}", file=sys.stderr)
              
              all_findings = []
              
              for i, js_url in enumerate(js_urls, 1):
                  print(f"[{i}/{len(js_urls)}] {os.path.basename(js_url)}", file=sys.stderr)
                  
                  js_file = f"tmp/js_{i}.js"
                  try:
                      import subprocess
                      result = subprocess.run(
                          ["curl", "-sL", "--max-time", "10", js_url, "-o", js_file],
                          capture_output=True,
                          timeout=12
                      )
                      
                      if result.returncode != 0:
                          print(f"  ‚ö†Ô∏è Download failed", file=sys.stderr)
                          continue
                      
                      with open(js_file, 'r', errors='ignore') as f:
                          js_content = f.read()
                      
                      if len(js_content) < 100:
                          continue
                      
                      findings = await analyze_js_file(js_url, js_content)
                      
                      if findings:
                          print(f"  üî• {len(findings)}", file=sys.stderr)
                          all_findings.extend(findings)
                      else:
                          print(f"  ‚úì", file=sys.stderr)
                  
                  except Exception as e:
                      print(f"  ‚ö†Ô∏è {e}", file=sys.stderr)
              
              print(json.dumps(all_findings, indent=2))
              
              with open("js_findings.json", "w") as f:
                  json.dump(all_findings, f, indent=2)
              
              print(f"\nüìä Total: {len(all_findings)}", file=sys.stderr)
          
          
          if __name__ == "__main__":
              asyncio.run(main())
          PYTHON_SCRIPT
          
          chmod +x intelligent_js_scanner.py
          echo "‚úÖ Scanner created"

      - name: Run Intelligent Reconnaissance
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          set -euo pipefail
          
          mkdir -p final_reports screenshots tmp
          
          domains_scanned=0
          screenshots_taken=0
          js_files_analyzed=0
          findings_found=0
          
          # Validate targets
          if [[ ! -f targets.txt ]]; then
            echo "‚ö†Ô∏è Creating default targets.txt"
            echo "example.com" > targets.txt
          fi
          
          if [[ ! -s targets.txt ]]; then
            echo "‚ö†Ô∏è Empty targets.txt, using default"
            echo "example.com" > targets.txt
          fi
          
          # Select targets
          grep -v '^#' targets.txt | grep -v '^$' | shuf -n 4 > tmp/selected.txt || echo "example.com" > tmp/selected.txt
          
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üß† INTELLIGENT JS SCANNER"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          cat tmp/selected.txt | nl
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          [[ -n "${GROQ_API_KEY:-}" ]] && echo "‚úÖ Groq enabled" || echo "‚ö†Ô∏è Pattern-only"
          echo ""
          
          # Process domains
          while read -r domain; do
            [[ -z "$domain" ]] && continue
            domain=$(echo "$domain" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')
            [[ -z "$domain" ]] && continue
            
            domains_scanned=$((domains_scanned + 1))
            
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "üîç DOMAIN $domains_scanned: $domain"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            
            report="final_reports/REPORT_${domain}.md"
            
            {
              echo "# üß† JS Security Scan: $domain"
              echo "**Date:** $(date '+%Y-%m-%d %H:%M UTC')"
              echo "**Run:** #${{ github.run_number }}"
              echo ""
            } > "$report"
            
            # Screenshot
            echo "üì∏ Screenshot..."
            timeout 25s /usr/local/bin/gowitness single "https://$domain" -P screenshots/ --disable-db 2>/dev/null && sleep 2 || true
            
            latest=$(find screenshots/ -type f -name "*.png" -newer "$report" 2>/dev/null | head -1)
            if [[ -n "$latest" ]]; then
              mv "$latest" "screenshots/${domain}.png" 2>/dev/null && screenshots_taken=$((screenshots_taken + 1)) || true
            fi
            
            [[ -f "screenshots/${domain}.png" ]] && echo "## üì∏ Screenshot: \`${domain}.png\`" >> "$report" && echo "" >> "$report"
            
            # JS Analysis
            echo "üß† JS Analysis..."
            echo "## üß† JavaScript Analysis" >> "$report"
            
            timeout 70s katana -u "https://$domain" -jc -d 2 -silent > tmp/urls_raw_${domain}.txt 2>/dev/null || touch tmp/urls_raw_${domain}.txt
            
            if [[ -s tmp/urls_raw_${domain}.txt ]]; then
              grep -iE '\.js(\?|$)' tmp/urls_raw_${domain}.txt | \
                grep -iv '\.json' | \
                grep -vEi '(webpack|jquery|bootstrap|react|angular|vue|framework|chunk|bundle|vendor|node_modules)' | \
                sort -u | head -n 10 > tmp/js_filtered_${domain}.txt || true
              
              js_count=$(wc -l < tmp/js_filtered_${domain}.txt 2>/dev/null || echo "0")
              
              if [[ $js_count -gt 0 ]]; then
                echo "**Analyzing $js_count files...**" >> "$report"
                echo "" >> "$report"
                
                python3 intelligent_js_scanner.py tmp/js_filtered_${domain}.txt > tmp/scanner_output_${domain}.json 2>&1 || true
                
                if [[ -f tmp/scanner_output_${domain}.json ]] && [[ -s tmp/scanner_output_${domain}.json ]]; then
                  finding_count=$(jq '. | length' tmp/scanner_output_${domain}.json 2>/dev/null || echo "0")
                  
                  if [[ $finding_count -gt 0 ]]; then
                    findings_found=$((findings_found + finding_count))
                    
                    echo "### üö® Findings ($finding_count)" >> "$report"
                    echo "" >> "$report"
                    
                    jq -r '.[] | "#### \(.severity): \(.type)\n**URL:** `\(.url)`\n\n```javascript\n\(if .evidence then .evidence else .context end)\n```\n"' tmp/scanner_output_${domain}.json >> "$report" 2>/dev/null || cat tmp/scanner_output_${domain}.json >> "$report"
                    
                    echo "" >> "$report"
                    cp tmp/scanner_output_${domain}.json "tmp/findings_${domain}.json"
                  else
                    echo "*‚úÖ Clean*" >> "$report"
                    echo "" >> "$report"
                  fi
                  
                  js_files_analyzed=$((js_files_analyzed + js_count))
                fi
              else
                echo "*No JS found*" >> "$report"
                echo "" >> "$report"
              fi
            else
              echo "*No JS discovered*" >> "$report"
              echo "" >> "$report"
            fi
            
            echo "‚úÖ Done: $domain"
            [[ $domains_scanned -lt 4 ]] && sleep 2
            
          done < tmp/selected.txt
          
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üìä COMPLETE"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "Domains: $domains_scanned"
          echo "JS Files: $js_files_analyzed"
          echo "Findings: $findings_found"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          echo "DOMAINS_SCANNED=$domains_scanned" >> $GITHUB_ENV
          echo "SCREENSHOTS_TAKEN=$screenshots_taken" >> $GITHUB_ENV
          echo "JS_FILES_ANALYZED=$js_files_analyzed" >> $GITHUB_ENV
          echo "FINDINGS_FOUND=$findings_found" >> $GITHUB_ENV
          
          [[ $findings_found -gt 0 ]] && echo "HAS_FINDINGS=true" >> $GITHUB_ENV || echo "HAS_FINDINGS=false" >> $GITHUB_ENV

      - name: Generate Summary
        if: always()
        run: |
          mkdir -p final_reports
          
          cat > final_reports/SUMMARY.md << SUMMARY_EOF
          # üß† JS Security Scanner - Summary
          
          **Date:** $(date '+%Y-%m-%d %H:%M UTC')
          **Run:** #${{ github.run_number }}
          
          ## üìä Stats
          
          | Metric | Count |
          |--------|------:|
          | Domains | ${DOMAINS_SCANNED:-0} |
          | JS Files | ${JS_FILES_ANALYZED:-0} |
          | Findings | ${FINDINGS_FOUND:-0} |
          
          ## üéØ Targets
          
          $(cat tmp/selected.txt 2>/dev/null | nl || echo "None")
          
          ## üîç Result
          
          $(if [[ "${FINDINGS_FOUND:-0}" -gt 0 ]]; then echo "üö® ${FINDINGS_FOUND} issue(s)"; else echo "‚úÖ Clean"; fi)
          
          ## üìù Reports
          
          $(ls final_reports/REPORT_*.md 2>/dev/null | sed 's/final_reports\//- /' || echo "- None")
          SUMMARY_EOF

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-${{ github.run_number }}
          path: |
            final_reports/
            screenshots/
            tmp/*.json
          retention-days: 14

      - name: Email Report
        if: always() && env.DOMAINS_SCANNED != '0'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "${{ env.HAS_FINDINGS == 'true' && 'üö®' || '‚úÖ' }} JS Scan | ${{ env.FINDINGS_FOUND }} Finding(s)"
          to: ${{ secrets.EMAIL_USERNAME }}
          from: JS Scanner <scan@security.local>
          body: |
            üß† JS SECURITY SCAN
            
            üìÖ $(date '+%Y-%m-%d %H:%M UTC')
            
            üìä RESULTS
            ‚Ä¢ Domains:   ${{ env.DOMAINS_SCANNED }}
            ‚Ä¢ JS Files:  ${{ env.JS_FILES_ANALYZED }}
            ‚Ä¢ Findings:  ${{ env.FINDINGS_FOUND }}
            
            ${{ env.HAS_FINDINGS == 'true' && 'üö® ISSUES FOUND' || '‚úÖ CLEAN' }}
            
            üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          attachments: final_reports/*
          priority: ${{ env.HAS_FINDINGS == 'true' && 'high' || 'normal' }}

      - name: Cleanup
        if: always()
        run: rm -rf tmp/*.js 2>/dev/null || true
