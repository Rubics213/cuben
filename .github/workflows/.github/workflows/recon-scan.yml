name: Recon and Analysis
on:
  push:
    branches: [main, master]
    paths:
      - '**.js'
      - 'targets.txt'

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Run Recon and Analyze
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Detect files
          FILES=$(git diff --name-only HEAD^ HEAD | grep -E '\.js$|targets\.txt' || true)
          
          if [ -z "$FILES" ]; then
            echo "No files found to analyze."
            exit 0
          fi

          # 2. Analyze
          for file in $FILES; do
            filename=$(basename "$file")
            echo "Analyzing $filename..."
            gemini --yolo -p "@$file Perform a security analysis. Search for endpoints and secrets." > "ANALYSIS_${filename}.md"
          done

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ANALYSIS_*.md
          if-no-files-found: error
