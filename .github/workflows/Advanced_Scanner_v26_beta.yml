- name: Run Optimized Recon
        shell: bash
        env:
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
        run: |
          set -uo pipefail

          mkdir -p final_reports tmp

          domains_scanned=0
          js_files_analyzed=0
          high_priority_findings=0
          vulnerabilities_found=0

          PRIORITY_REGEX='(?i)\b(api_key|secret|password|token|bearer|aws_access|private_key)\b\s*[:=]\s*["\047][^"\047]{3,}["\047]'
          BOILERPLATE_FILTER="type:|config:|next/image|datetime-local|scheme:|username:|password:|placeholder|example|demo"

          if [[ ! -f targets.txt ]] || [[ ! -s targets.txt ]]; then
            echo "âŒ targets.txt is missing or empty"
            exit 0
          fi

          # Select up to 4 random non-comment, non-empty lines
          grep -vE '^\s*#|^\s*$' targets.txt | shuf -n 4 > tmp/selected.txt || true

          while IFS= read -r domain || [[ -n "$domain" ]]; do
            [[ -z "$domain" ]] && continue
            domain=$(echo "$domain" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')
            domains_scanned=$((domains_scanned + 1))

            echo "ðŸ” DOMAIN $domains_scanned/4: $domain"
            # Clean domain name for filename
            safe_name=$(echo "$domain" | sed 's/[^a-z0-9]/_/g')
            report="final_reports/REPORT_${safe_name}.md"

            cat > "$report" << EOF
          # ðŸ›¡ï¸ Security Recon: $domain
          **Scan Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          ---
          EOF

            # JS Analysis
            echo "ðŸ“œ Analyzing JavaScript..."
            echo "## ðŸ“œ JavaScript Analysis" >> "$report"

            timeout 70s katana -u "https://$domain" -jc -d 2 -silent < /dev/null > tmp/raw_urls.txt 2>/dev/null || touch tmp/raw_urls.txt

            if [[ -s tmp/raw_urls.txt ]]; then
              # FIX: Decouple sort and head to prevent "Broken Pipe" error
              grep -iE '\.js(\?|$)' tmp/raw_urls.txt \
                | grep -iv '\.json' \
                | grep -vEi '(webpack|jquery|bootstrap|react|angular|vue|framework|polyfill|chunk|bundle|vendor|node_modules)' \
                | sort -u > tmp/sorted_js.txt
              
              head -n 8 tmp/sorted_js.txt > tmp/js_filtered.txt || true

              if [[ -s tmp/js_filtered.txt ]]; then
                local_findings=0
                while IFS= read -r js_url; do
                  [[ -z "$js_url" ]] && continue
                  js_files_analyzed=$((js_files_analyzed + 1))

                  timeout 12s curl -sL --max-time 10 "$js_url" -o tmp/current.js 2>/dev/null || continue
                  sed -i 's/;/;\n/g; s/{/{\n/g; s/}/}\n/g' tmp/current.js 2>/dev/null || true

                  high_signal=$(grep -oP -m 5 ".{0,50}${PRIORITY_REGEX}.{0,50}" tmp/current.js 2>/dev/null \
                                | grep -vEi "$BOILERPLATE_FILTER" \
                                | head -n 3) || true

                  if [[ -n "$high_signal" ]]; then
                    echo "### ðŸš¨ HIGH PRIORITY: $(basename "$js_url")" >> "$report"
                    echo "**URL:** \`$js_url\`" >> "$report"
                    echo '```javascript' >> "$report"
                    echo "$high_signal" >> "$report"
                    echo '```' >> "$report"
                    local_findings=$((local_findings + 1))
                    high_priority_findings=$((high_priority_findings + 1))
                  fi
                done < tmp/js_filtered.txt

                [[ $local_findings -eq 0 ]] && echo "*âœ“ No sensitive patterns detected*" >> "$report"
              else
                echo "*No interesting JS files found*" >> "$report"
              fi
            fi

            # Nuclei Scan
            echo "ðŸ›¡ï¸ Vulnerability scan..."
            echo "## ðŸ›¡ï¸ Vulnerability Scan" >> "$report"

            nuclei_output=$(mktemp)
            timeout 80s nuclei -u "https://$domain" -severity critical,high -silent -nc < /dev/null > "$nuclei_output" 2>/dev/null || true

            if [[ -s "$nuclei_output" ]]; then
              vuln_count=$(wc -l < "$nuclei_output")
              vulnerabilities_found=$((vulnerabilities_found + vuln_count))
              echo '```text' >> "$report"
              cat "$nuclei_output" >> "$report"
              echo '```' >> "$report"
            else
              echo "*âœ“ No critical/high issues found*" >> "$report"
            fi
            rm -f "$nuclei_output"

          done < tmp/selected.txt

          # Export metrics
          echo "DOMAINS_SCANNED=$domains_scanned" >> $GITHUB_ENV
          echo "JS_FILES_ANALYZED=$js_files_analyzed" >> $GITHUB_ENV
          echo "HIGH_PRIORITY_FINDINGS=$high_priority_findings" >> $GITHUB_ENV
          echo "VULNERABILITIES_FOUND=$vulnerabilities_found" >> $GITHUB_ENV
          total_issues=$((high_priority_findings + vulnerabilities_found))
          echo "TOTAL_ISSUES=$total_issues" >> $GITHUB_ENV
          echo "HAS_FINDINGS=$([[ $total_issues -gt 0 ]] && echo true || echo false)" >> $GITHUB_ENV
